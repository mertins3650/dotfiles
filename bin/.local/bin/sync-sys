#!/bin/bash

# ============================================================
# Arch system maintenance & dotfiles sync script
# ============================================================

set -euo pipefail

CURRENT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# ------------------------------------------------------------
# Git safety check function
# ------------------------------------------------------------
check_git_pull_safe() {
    local dir="$1"
    local branch

    if ! git -C "$dir" rev-parse --is-inside-work-tree >/dev/null 2>&1; then
        return 0
    fi

    branch=$(git -C "$dir" symbolic-ref --short HEAD 2>/dev/null) || return 0

    if [[ -n $(git -C "$dir" diff --name-only --diff-filter=U) ]]; then
        echo "Merge conflicts detected in $dir"
        return 1
    fi

    if ! git -C "$dir" show-ref --verify --quiet "refs/remotes/origin/$branch"; then
        echo "No upstream tracking branch for $dir ($branch)"
        return 0
    fi

    if [[ -n $(git -C "$dir" rev-list --left-only origin/"$branch"...HEAD) ]]; then
        echo "Local branch is ahead of origin/$branch in $dir"
        read -r -p "Continue anyway? (y/N): " REPLY || return 1
        [[ $REPLY =~ ^[Yy]$ ]] || return 1
    fi

    if [[ -n $(git -C "$dir" status --porcelain) ]]; then
        echo "Uncommitted changes in $dir"
        read -r -p "Continue anyway? (y/N): " REPLY || return 1
        [[ $REPLY =~ ^[Yy]$ ]] || return 1
    fi

    return 0
}

# ------------------------------------------------------------
# Pre-flight git checks (NO SNAPSHOT YET)
# ------------------------------------------------------------
if ! check_git_pull_safe "$ARCH_SETUP_PATH"; then
    echo "Aborting due to unsafe git state in ARCH_SETUP_PATH."
    exit 1
fi

if ! check_git_pull_safe "$DOTFILES_PATH"; then
    echo "Aborting due to unsafe git state in DOTFILES_PATH."
    exit 1
fi

# ------------------------------------------------------------
# Snapshot + bootloader sync (SAFE POINT)
# ------------------------------------------------------------
snapshot create
sudo limine-snapper-sync

# ------------------------------------------------------------
# ARCH SETUP
# ------------------------------------------------------------
cd "$ARCH_SETUP_PATH"
git pull --no-rebase

BASE_PACKAGES_FILE="$HOME/archsetup/base.packages"
mapfile -t packages < <(grep -v '^\s*#' "$BASE_PACKAGES_FILE")

paru -Syu --noconfirm --needed "${packages[@]}" || {
    echo "paru failed â€” system may be partially upgraded"
    exit 1
}

# ------------------------------------------------------------
# DOTFILES
# ------------------------------------------------------------
cd "$DOTFILES_PATH"
git pull --no-rebase

for dir in */; do
    [[ -d "$dir" ]] || continue
    dir="${dir%/}"
    echo "Stowing $dir..."
    stow --target="$HOME" --verbose=2 "$dir"
done

# ------------------------------------------------------------
# THEME
# ------------------------------------------------------------
if [[ -f "$ARCHY_PATH/theme/theme.name" ]]; then
    CURRENT_THEME_NAME=$(<"$ARCHY_PATH/theme/theme.name")
else
    CURRENT_THEME_NAME="catppuccin"
fi

set-theme "$CURRENT_THEME_NAME"

# ------------------------------------------------------------
# Cleanup
# ------------------------------------------------------------
cd "$CURRENT_DIR"
notify-send "Sync and update complete."

